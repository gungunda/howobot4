@layer reset, tokens, base, layout, components, utilities;

/* ---------------------------------------
   RESET
--------------------------------------- */
@layer reset {
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin: 0; }
  img, svg, video, canvas { display: block; max-width: 100%; height: auto; }
  button, input, textarea, select { font: inherit; }
}

/* ---------------------------------------
   TOKENS (цвета, шрифты, отступы)
--------------------------------------- */
@layer tokens {
  :root{
    color-scheme: light dark; /* подсказка UA для корректных системных цветов/скроллбаров */

    /* Цвета */
    --bg: #ffffff;
    --fg: #1f2328;
    --muted: #6a737d;
    --primary: #4981a6;
    --primary-contrast: #ffffff;
    --border: #c7cfd8;
    --card: #f8fafc;
    --focus-ring: rgba(11, 255, 88, 0.5);
    --button: #e1e4e9; 

    /* Доп. токены для состояния/акцентов */
    --accent-soft: rgba(11,95,255,.08);
    --sel: rgba(11,95,255,.12);

    /* Типографика */
    --font-ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

    /* Шаги отступов (rem) */
    --s-0: 0rem;
    --s-1: 0.25rem;   /* 4px */
    --s-2: 0.5rem;    /* 8px */
    --s-3: 0.75rem;   /* 12px */
    --s-4: 1rem;      /* 16px */
    --s-5: 1.5rem;    /* 24px */
    --s-6: 2rem;      /* 32px */
    --s-7: 3rem;      /* 48px */

    /* Радиусы */
    --r-1: 0.375rem;  /* 6px */
    --r-2: 0.5rem;    /* 8px */
    --r-3: 0.75rem;   /* 12px */

    /* Тени — лёгкие для мобилок */
    --shadow-1: 0 1px 2px rgba(0,0,0,.06);
    --shadow-2: 0 10px 30px rgba(0,0,0,.25);

    /* Масштаб текста (примерная шкала) */
    --fs-xs: 0.8125rem; /* 13px */
    --fs-sm: 0.875rem;  /* 14px */
    --fs-md: 1rem;      /* 16px */
    --fs-lg: clamp(1.125rem, 1rem + 1vw, 1.25rem);  /* ~18–20px */
    --fs-xl: clamp(1.25rem, 1rem + 2vw, 1.5rem);    /* ~20–24px */
  }

  @media (prefers-color-scheme: dark) {
    :root{
      --bg: #0b0e12;
      --fg: #e8edf2;
      --muted: #9aa5b1;
      --border: #475f85;
      --card: #11161d;
      --primary: #829cc5;
      --focus-ring: rgba(59,130,246,.5);
      --button: #2b3354;
      --accent-soft: rgba(59,130,246,.14);
      --sel: rgba(59,130,246,.18);

    }
  }
}

/* ---------------------------------------
   БАЗА
--------------------------------------- */
@layer base {
  html { font-size: 100%; }
  body {
    min-height: 100dvh;
    font-family: var(--font-ui);
    background: var(--bg);
    color: var(--fg);
    line-height: 1.5;
    padding-inline: clamp(12px, 4vw, 24px);
    /* Safe areas по странице */
    padding-block-start: max(var(--s-4), env(safe-area-inset-top));
    padding-block-end: max(var(--s-4), env(safe-area-inset-bottom));
    scrollbar-gutter: stable both-edges;
  }

  /* Доступный фокус */
  :where(a, button, [role="button"], input, select, textarea):focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  /* Утилиты типографики */
  .muted { color: var(--muted); }
  .small { font-size: var(--fs-sm); }

  /* CLS-хелперы для медиа */
  .media { display:block; width:100%; height:auto; }
  .media-16x9 { aspect-ratio: 16 / 9; }
  .media-4x3  { aspect-ratio: 4 / 3; }
  .media-1x1  { aspect-ratio: 1 / 1; }
}

/* ---------------------------------------
   LAYOUT (адаптив без ломки DOM)
--------------------------------------- */
@layer layout {
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap: var(--s-3);
    padding: max(var(--s-2), env(safe-area-inset-top)) var(--s-3) var(--s-3);
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    position: sticky; top: 0; z-index: 10;
    overscroll-behavior: contain;
  }
  .topbar-title{ font-weight:600; font-size: var(--fs-lg); }
  .topbar-nav{ display:flex; gap: var(--s-2); flex-wrap: wrap; }

  .main{
    padding-block: var(--s-4);
    margin-top: calc(var(--s-6));
    max-width: 42rem;            /* ≈ 672px */
    margin-inline: auto;
    width: 100%;
    container-type: inline-size;
  }

  .section{ margin-block: var(--s-4); }
  .section-title{ margin: 0 0 var(--s-3); font-size: var(--fs-lg); }

  
  .stat-box{ padding: var(--s-1) var(--s-2); border:1px solid var(--border); border-radius: var(--r-2); background: var(--card); box-shadow: var(--shadow-1); }

  .view{ display:none; }
  .view.is-active{ display:block; }

  .row{ display:flex; gap: var(--s-2); align-items:center; flex-wrap:wrap; }
  .task-list{ display:flex; flex-direction:column; gap: var(--s-2); }

  .week-grid{ display:grid; grid-template-columns: repeat(1, 1fr); gap: var(--s-3); }
  @media (min-width: 720px){ .week-grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (min-width: 1024px){ .week-grid{ grid-template-columns: repeat(3, 1fr); } }

  .calendar-header{ display:flex; align-items:center; gap: var(--s-2); margin-block: var(--s-2); }

  .calendar-grid{
    display:grid; grid-template-columns:repeat(7,1fr); gap: var(--s-2);
    border-top:2px solid var(--border); padding-top: var(--s-2);
  }

  .footer{
    padding: var(--s-3) var(--s-4);
    padding-bottom: max(var(--s-3), env(safe-area-inset-bottom));
    border-top:1px solid var(--border);
    max-width: 42rem;
    margin-inline: auto;
    width: 100%;
  }

  @supports (container-type: inline-size) {
    @container (min-width: 40rem) { .week-grid{ grid-template-columns: repeat(2, 1fr); } }
    @container (min-width: 64rem) { .week-grid{ grid-template-columns: repeat(3, 1fr); } }
    @container (min-width: 30rem) { .stat-box{ flex: 1 1 calc(33.333% - var(--s-3)); } }
    @container (min-width: 48rem) { .stat-box{ flex: 1 1 calc(25% - var(--s-3)); min-width: 10rem; } }
  }

  @media (max-width: 360px) {
    .topbar { padding-inline: var(--s-3); }
    .calendar-grid { gap: var(--s-1); }
    .calendar-grid .cell { padding: 0.5rem; }
  }
}

/* ---------------------------------------
   COMPONENTS (микро-полировка UI)
--------------------------------------- */
@layer components {
  /* ---------- Buttons ---------- */
  .btn{
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .5em;
    padding: 0.35rem 0.5rem;
    border:1px solid var(--border);
    background: var(--button);
    border-radius: var(--r-2);
    cursor:pointer;
    font-size: var(--fs-md);
    line-height: 1.2;
    min-height: 2.25rem;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    transition: box-shadow .15s ease, transform .05s ease, background-color .15s ease;
    color: var(--fg);
    min-width: 2.5rem; 
  }
  @media (hover: hover) {
    .btn:hover{ box-shadow: 0 1px 0 rgba(0,0,0,.06); background: var(--accent-soft); }
  }
  .btn:active{ transform: translateY(1px); }
  .btn:disabled{ opacity:.6; cursor: not-allowed; }

  .btn:focus-visible { outline: 3px solid var(--focus-ring); outline-offset: 2px; }

  .icon { width: 1.25em; height: 1.25em; vertical-align: -0.125em; filter: grayscale(50); }
  .btn-img { filter: sepia(100%) brightness(90%) hue-rotate(191deg) saturate(100%) contrast(200%); }

  /* ---------- Inputs & Form Controls ---------- */
  .input,
  input[type="text"],
  input[type="number"],
  input[type="search"],
  input[type="time"],
  select, textarea{
    padding: 0.5rem 0.625rem;
    border:1px solid var(--border);
    border-radius: var(--r-1);
    min-height: 2.25rem;
    font-size: var(--fs-md);
    inline-size: 100%;
    background: var(--bg);
    transition: border-color .15s ease, box-shadow .15s ease;
  }
  input[type="checkbox"] {appearance: none; accent-color: var(--primary); border:1px solid var(--border); background: var(--bg);}
  input::placeholder, textarea::placeholder{ color: var(--muted); }
  :where(.input, input, select, textarea):focus-visible{
    outline: 3px solid var(--focus-ring);
    outline-offset: 2px;
    border-color: var(--primary);
  }
  :where(.input, input, select, textarea):disabled{
    opacity:.7; background: var(--bg); cursor:not-allowed;
  }

  /* ---------- Cards ---------- */
  .card{ border:1px solid var(--border); background: var(--card); padding: var(--s-3); border-radius: var(--r-3); margin-block: var(--s-2); box-shadow: var(--shadow-1); }
  .card-title{ font-weight:600; margin: 0 0 var(--s-2); font-size: var(--fs-md); }
  .card-actions{ display:flex; gap: var(--s-2); flex-wrap: wrap;  justify-content: flex-start;   }
  .card-percents {margin: var(--s-1) 0; padding: var(--s-1) 0;}

  /* ---------- Schedule ---------- */
   .day-title{  margin: 0 0 var(--s-2); text-transform: capitalize;}

  /* ---------- Calendar cells ---------- */
  .calendar-grid .cell{
    display:flex; align-items:center; justify-content:center;
    padding: 0.5rem;
    border:2px solid var(--border); border-radius: var(--r-3);
    background:var(--bg); cursor:pointer; user-select:none;
    min-height: 2.75rem; /* было 2.625rem — довёл до ≥44px */
    transition: box-shadow .15s ease, background-color .15s ease, border-color .15s ease;
  }
  .calendar-grid .cell.is-head{
    background:transparent; border:none; font-weight:600; color:var(--muted); cursor:default;
  }
  .calendar-grid .cell.is-outside-month{ opacity:.5; }
  .calendar-grid .cell.is-today{ outline:2px solid var(--primary); outline-offset: 2px; }
  .calendar-grid .cell.is-selected,
  .calendar-grid .cell[aria-selected="true"],
  .calendar-grid .cell[data-selected="true"]{
    background: var(--sel);
    border-color: var(--primary);
  }
  @media (hover: hover) {
    .calendar-grid .cell:hover{ box-shadow:0 0 0 2px rgba(0,0,0,.04); background: var(--accent-soft); }
  }
  .calendar-grid .cell:focus-visible{ outline: 3px solid var(--focus-ring); outline-offset: 2px; }

  /* ---------- Modal ---------- */
  .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1000;  }
  .modal[open] { display: flex; }
  .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.75); }
  .modal-card {
    position: relative;
    background: var(--bg);
    width: min(30rem, 92vw);
    max-height: 88dvh;
    overflow: auto;   
    border:2px solid var(--border); 
    border-radius: var(--r-3);
    box-shadow: var(--shadow-2);
    padding: var(--s-4);
    padding-bottom: max(var(--s-4), env(safe-area-inset-bottom));
  }
  .modal-close { position: absolute; top: var(--s-2); right: var(--s-2); border: none; background: transparent; font-size: 1.75rem; cursor: pointer; }
  .modal-card h3 { margin: 0 0 var(--s-3) 0; font-size: var(--fs-lg); }
  .form-row { display: flex; gap: var(--s-2); align-items: center; margin: var(--s-2) 0; }
  .form-row label { min-width: 6rem; }
  .form-row .unload-grid label { min-width: 0; }
  .form-actions {
    display: flex; gap: var(--s-2); justify-content: flex-end; margin-top: var(--s-3);
    position: sticky; bottom: 0; padding-top: var(--s-3);
    background: linear-gradient(to top, var(--bg), transparent);

  }
}

/* ---------------------------------------
   UTILITIES (в т.ч. улучшение UX)
--------------------------------------- */
@layer utilities {
  .topbar-title{ font-weight:600; }
  .section-title{ font-weight:600; }

  .sr-only{
    position:absolute !important; inline-size:1px !important; block-size:1px !important;
    padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important;
    white-space:nowrap !important; border:0 !important;
  }

  /* Утилита расширения тач-цели для компактных икон-кнопок */
  .tap-area {
    position: relative;
  }
  .tap-area::after {
    content: "";
    position: absolute;
    inset: -6px;          /* +12px к ширине/высоте зоны клика */
  }

  /* Виртуализация/экономия */
  @supports (content-visibility: auto) {
    .vlist > * { content-visibility: auto; contain-intrinsic-size: 160px; }
    .virtual-section { content-visibility: auto; contain-intrinsic-size: 600px 800px; }
  }
  @media (prefers-reduced-data: reduce) {
    :root { --shadow-1: none; --shadow-2: none; }
    .modal-card { box-shadow: none; }
    .btn { transition: none; }
  }
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; scroll-behavior: auto !important; }
  }
}

/* ---------------------------------------
   STAGE 10 ADDITIONS (minor layout glue for existing markup)
--------------------------------------- */
@layer layout {
  .section-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: var(--s-2);
    flex-wrap: wrap;
    margin-block: var(--s-2);
  }
  .calendar-header {
    justify-content: center;
  }
}
@layer components {
  .cal-label{
    min-width: 8ch;
    text-align: center;
    font-size: var(--fs-lg);
    font-weight: 600;
    text-transform: capitalize;
  }
}

@layer layout { .card-header{ justify-content: space-between; } }

@layer components {
  /* Прогресс: кнопки по краям, слайдер растягивается на всю ширину */
  .card .row .btn { flex: 0 0 auto; }
  .card .row .range {
    flex: 1 1 auto;
    min-inline-size: 0;
    accent-color: var(--primary);
  }
}

/* === Stats cards: uniform layout (1col → 2col → 4col) === */
@layer layout {
  /* Switch stats row to CSS Grid to avoid last-item stretching */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(1, 1fr); /* 4 в столбец (мобилка) */
    gap: var(--s-3);
  }
  /* Neutralize previous flex sizing on stat boxes in grid context */
  .stat-box {
    flex: initial;
    min-width: 0;
  }
}

/* Fallback with media queries */
@media (min-width: 600px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); } /* 2 + 2 */
}
@media (min-width: 960px) {
  .stats-row { grid-template-columns: repeat(4, 1fr); } /* 4 в ряд */
}

/* Prefer container queries when available (main already has container-type) */
@supports (container-type: inline-size) {
  @container (min-width: 20rem) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
  @container (min-width: 36rem) { .stats-row { grid-template-columns: repeat(4, 1fr); } }
}


/* ---------- Schedule (точное соответствие текущему HTML) ---------- */
@layer components {
  /* Шапка дня: название + плюс справа */
  .week-grid .card > .row:first-child { justify-content: space-between; align-items: center; margin-bottom: var(--s-2);}

  /* Отступы между строками предметов */
  .week-grid .card > div > .row + .row { margin-block-start: var(--s-2); }

  /* Строка предмета — двухколоночная раскладка */
  .week-grid .card > div > .row {
    display: flex;
    align-items: center;
    gap: var(--s-1);
  }

  /* Левая колонка (название + время) — тянется */
  .week-grid .card > div > .row > .row:first-child {
    flex: 1 1 auto;
    min-inline-size: 0;
  }

  /* Правая колонка (разгрузка + кнопка) — прижать вправо, элементы в одну линию */
  .week-grid .card > div > .row > .row:last-child {
    margin-inline-start: auto;
    display: flex;
    align-items: center;
    gap: var(--s-2);
    flex: 0 0 auto;
    min-inline-size: max-content;
  }

  /* Кнопка редактирования фиксированной ширины */
  .week-grid .card > div > .row > .row:last-child > .btn {
    flex: 0 0 auto;
  }
}

/* ---------- Fixed topbar overlay (keeps nav visible on scroll) ---------- */
@layer layout {
  .topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--bg);
    box-shadow: 0 2px 8px rgba(0,0,0,.06);
  }

}

/* ---------- Schedule modals: unload label + checkbox group alignment ---------- */
@layer components {
  /* Правая колонка с чекбоксами тянется и не затекает под label */
  .modal-card .form-row .unload-wrap { flex: 1 1 auto; min-inline-size: 0; }

  /* Сетка разгрузки: компактные чекбоксы в несколько строк справа */
  .modal-card .unload-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--s-2);
  }
  .modal-card .unload-grid label {
    display: inline-flex;
    align-items: center;
    gap: var(--s-1);
    min-width: 0;
  }

  /* Узкий инпут минут: 3–4 символа */
  .modal-card [data-f-min] {
    inline-size: 10ch;
  }
}


