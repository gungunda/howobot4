FILE_INDEX_START
/src/ui/dashboard/presenter.js
/src/ui/dashboard/view.js
/index.html
FILE_INDEX_END


// /src/ui/dashboard/presenter.js

/** 
 * DashboardPresenter — презентер экрана «Дашборд».
 * Задачи дня правятся в DayTasks(D), где D = this.baseDate (прямо).
 * D+1 используется только для показа списка (шаблон расписания на завтра).
 */
import * as date from "../../../utils/date.js";
import { LoadDashboard } from "../../../usecases/LoadDashboard.js";
import { SetProgress } from "../../../usecases/SetProgress.js";
import { ToggleClosed } from "../../../usecases/ToggleClosed.js";
import { ResetDay } from "../../../usecases/ResetDay.js";
import { ResetToSchedule } from "../../../usecases/ResetToSchedule.js";
import { DashboardView } from "./view.js";
import { config } from "../../../config.js";
import { AddDayTask } from "../../../usecases/AddDayTask.js";
import { EditDayTask } from "../../../usecases/EditDayTask.js";
import { DropDayTask } from "../../../usecases/DropDayTask.js";

export class DashboardPresenter {
  /** @param {HTMLElement} sectionRoot */
  constructor(sectionRoot){
    this.root = sectionRoot;
    this.baseDate = date.today();
  }

  /** Рендер экрана. */
  render(){
    // D+1 — только для композиции показа
    const d1 = date.dPlus1(this.baseDate);
    const vm = LoadDashboard(d1);

    const els = {
      dateEl: this.root.querySelector('[data-dashboard-date]'),
      stats: {
        planned: this.root.querySelector('[data-dashboard-stat="planned"]'),
        done:    this.root.querySelector('[data-dashboard-stat="done"]'),
        left:    this.root.querySelector('[data-dashboard-stat="left"]'),
        eta:     this.root.querySelector('[data-dashboard-stat="eta"]'),
      },
      list: this.root.querySelector('[data-dashboard-tasks]'),
      offloadWrap: this.root.querySelector('[data-dashboard-offload-wrapper]'),
      offloadList: this.root.querySelector('[data-dashboard-offload]'),
            addBtn: this.root.querySelector('[data-action=\"add-task\"]'),
resetBtn: this.root.querySelector('[data-action="reset-day"]'),
      resetToScheduleBtn: this.root.querySelector('[data-action="reset-to-schedule"]'),
    };

    this.view = new DashboardView(els, {
      dateIso: date.toIsoDate(d1),
      vm,
      onStep: (taskId, sign) => this.onStep(taskId, sign),
      onSlide: (taskId, value) => this.onSlide(taskId, value),
      onToggle: (taskId) => this.onToggle(taskId),

      onResetDay: () => this.onResetDay(),
      onResetToSchedule: () => this.onResetToSchedule(),

      // модалки
      onAddSave: (title, minutes) => this.onAddSave(title, minutes),
      onEditSave: (taskId, title, minutes) => this.onEditSave(taskId, title, minutes),
      onDelete: (taskId) => this.onDelete(taskId),

      // оффлоад
      onOffloadStep: (taskId, targetIso, sign) => this.onOffloadStep(taskId, targetIso, sign),
      onOffloadSlide: (taskId, targetIso, value) => this.onOffloadSlide(taskId, targetIso, value),
    });

    this.view.render();
  }

  /** Полный перерендер. */
  refresh(){ this.render(); }

  // === Целевая дата для сохранений — СЕГОДНЯ (baseDate) ===
  get todayIso(){ return date.toIsoDate(this.baseDate); }

  /** Шаг прогресса ±10%. */
  onStep(taskId, sign){
    SetProgress({ date: this.todayIso, taskId, delta: sign * config.progressStep });
    this.refresh();
  }

  /** Ползунок прогресса (0..100). */
  onSlide(taskId, value){
    SetProgress({ date: this.todayIso, taskId, value: Number(value) });
    this.refresh();
  }

  /** Переключить закрыто/открыто. */
  onToggle(taskId){
    ToggleClosed({ date: this.todayIso, taskId });
    this.refresh();
  }

  onResetDay(){
    ResetDay({ date: this.todayIso });
    this.refresh();
  }

  /** Вернуть расписание (удалить оверрайд) */
  onResetToSchedule(){
    ResetToSchedule({ date: this.todayIso });
    this.refresh();
  }

  /** Добавить новую задачу в сегодня. */
  onAddSave(title, minutes){
    AddDayTask({ date: this.todayIso, title, minutes });
    this.refresh();
  }

  /** Сохранить правку существующей задачи. */
  onEditSave(taskId, title, minutes){
    EditDayTask({ date: this.todayIso, taskId, title, minutes });
    this.refresh();
  }

  /** Удалить задачу из DayTasks(сегодня). */
  onDelete(taskId){
    DropDayTask({ date: this.todayIso, taskId });
    this.refresh();
  }

  /** Оффлоад — шаг ±10%. */
  onOffloadStep(taskId, targetIso, sign){
    SetProgress({ date: targetIso, taskId, delta: sign * config.progressStep });
    this.refresh();
  }

  /** Оффлоад — ползунок. */
  onOffloadSlide(taskId, targetIso, value){
    SetProgress({ date: targetIso, taskId, value: Number(value) });
    this.refresh();
  }
}





// /src/ui/dashboard/view.js

/** 
 * DashboardView — отображение дашборда.
 * Модалка и кнопка "+" создаются динамически (index.html править не нужно).
 * Инлайнового редактирования минут НЕТ — правка через модалку.
 */
import { minutesToHhmm } from "../../../utils/date.js";
import { ensureModalRoot, openModal } from "../../components/modal.js";

const DAY_NAMES = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];

export class DashboardView{
  /**
   * @param {object} els - ссылки на элементы DOM
   * @param {object} handlers - колбэки презентера
   */
  constructor(els, handlers){
    /** @type {any} */
    this.els = els;
    /** @type {any} */
    this.h = handlers;

    // Готовим модалку (если нет в DOM — создадим)
    ensureModalRoot();
  }

  /** Отрисовать дашборд. */
  render(){
    const { dateIso, vm } = this.h;

    if (this.els.dateEl) this.els.dateEl.textContent = `(${dateIso})`;
    this.els.stats.planned.textContent = vm.metrics.load || "0:00";
    this.els.stats.done.textContent    = vm.metrics.done ?? "0%";
    this.els.stats.left.textContent    = vm.metrics.left || "0:00";
    // ETA может называться finish — поддержим оба поля
    this.els.stats.eta.textContent     = vm.metrics.eta || vm.metrics.finish || "0:00";

    // Кнопки «Очистить день» и «Вернуть к расписанию»
    if (this.els.resetBtn){ this.els.resetBtn.onclick = () => this.h.onResetDay(); }
    if (this.els.resetToScheduleBtn){ this.els.resetToScheduleBtn.onclick = () => this.h.onResetToSchedule(); }

    // Список задач дня
    this.els.list.innerHTML = "";
    vm.tasks.forEach(t => this.els.list.appendChild(this.renderTaskCard(t)));

    // Кнопка «+» из DOM (как и прочие кнопки)
    if (this.els.addBtn) { this.els.addBtn.onclick = () => this.openAddForm(); }
// Разгрузка
    if (this.els.offloadWrap){
      const hasOffload = (vm.offload && vm.offload.length > 0);
      this.els.offloadWrap.hidden = !hasOffload;
      this.els.offloadList.innerHTML = "";
      if (hasOffload){
        vm.offload.forEach(o => this.els.offloadList.appendChild(this.renderOffloadCard(o)));
      }
    }
  }

    /** Открыть модалку для добавления новой задачи в сегодня. */
  openAddForm(){
    const node = document.createElement("div");
    node.innerHTML = `
      <h3>Новая задача на сегодня</h3>
      <div class="form-row">
        <label>Название</label>
        <input data-f-title placeholder="Предмет" />
      </div>
      <div class="form-row">
        <label>Минуты</label>
        <input data-f-min type="number" min="0" step="5" value="25" />
      </div>
      <div class="form-actions">
        <button class="btn primary" data-save>Добавить</button>
      </div>
    `;
    openModal(node, {
      onSave: () => {
        const title = (node.querySelector('[data-f-title]')?.value || "").trim();
        const minutes = Number(node.querySelector('[data-f-min]')?.value || 0);
        if (!title) return; // простая валидация
        this.h.onAddSave(title, minutes);
      }
    });
  }

  /** Открыть модалку для редактирования существующей задачи. */
  openEditForm(t){
    const node = document.createElement("div");
    node.innerHTML = `
      <h3>Правка задачи</h3>
      <div class="form-row">
        <label>Название</label>
        <input data-f-title value="${t.title}" />
      </div>
      <div class="form-row">
        <label>Минуты</label>
        <input data-f-min type="number" min="0" step="5" value="${t.minutes}" />
      </div>
      <div class="form-actions">
        <button class="btn btn-danger" data-delete>Удалить</button>
        <button class="btn primary" data-save>Сохранить</button>
      </div>
    `;
    const close = openModal(node, {
      onSave: () => {
        const title = (node.querySelector('[data-f-title]')?.value || "").trim();
        const minutes = Number(node.querySelector('[data-f-min]')?.value || 0);
        if (!title) return;
        this.h.onEditSave(t.id, title, minutes);
      }
    });
    node.querySelector("[data-delete]")?.addEventListener("click", () => {
      this.h.onDelete(t.id);
      close();
    }, { once: true });
  }

  /** Карточка основной задачи (без инлайнового редактирования минут). */
  renderTaskCard(t){
    const card = document.createElement("div");
    card.className = "card";
    const hhmm = minutesToHhmm(t.minutes);
    card.innerHTML = `
      <div class="row">
        <strong>${t.title}</strong>
        <span class="muted">${hhmm}</span>
      </div>
      <div class="row">
        <button class="btn" data-step="-1">−10%</button>
        <input class="range" type="range" min="0" max="100" step="10" value="${t.progress}">
        <button class="btn" data-step="+1">+10%</button>
        <span>${t.progress}%</span>
        <button class="btn" data-action="toggle">${t.closed ? "Открыть" : "Закрыть"}</button>
        <button class="btn" data-action="edit">Править</button>
      </div>
    `;
    card.querySelector('[data-step="-1"]').addEventListener("click", () => this.h.onStep(t.id, -1));
    card.querySelector('[data-step="+1"]').addEventListener("click", () => this.h.onStep(t.id, +1));
    card.querySelector('.range').addEventListener("input", (e) => this.h.onSlide(t.id, e.target.value));
    card.querySelector('[data-action="toggle"]').addEventListener("click", () => this.h.onToggle(t.id));
    card.querySelector('[data-action="edit"]').addEventListener("click", () => this.openEditForm(t));
    return card;
  }

  /** Карточка разгрузки. */
  renderOffloadCard(o){
    const card = document.createElement("div");
    card.className = "card";
    const hhmm = minutesToHhmm(o.minutes);
    card.innerHTML = `
      <div class="row">
        <strong>${o.title}</strong>
        <span class="muted">${hhmm}</span>
        <span class="muted">из дня: ${DAY_NAMES[o.fromWeekday]}</span>
      </div>
      <div class="row">
        <button class="btn" data-step="-1">−10%</button>
        <input class="range" type="range" min="0" max="100" step="10" value="${o.progress}">
        <button class="btn" data-step="+1">+10%</button>
        <span>${o.progress}%</span>
      </div>
    `;
    card.querySelector('[data-step="-1"]').addEventListener("click", () => this.h.onOffloadStep(o.id, o.targetIso, -1));
    card.querySelector('[data-step="+1"]').addEventListener("click", () => this.h.onOffloadStep(o.id, o.targetIso, +1));
    card.querySelector('.range').addEventListener("input", (e) => this.h.onOffloadSlide(o.id, o.targetIso, e.target.value));
    return card;
  }
}



// /index.html
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=yes"
    />
    <title>Лёшин планировщик</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-title">Лёшин планировщик</div>
      <nav class="topbar-nav">
        <button class="btn" data-nav="dashboard">Сегодня</button>
        <button class="btn" data-nav="schedule">Расписание</button>
        <button class="btn" data-nav="calendar">Календарь</button>
      </nav>
    </header>

    <main class="main">
      <!-- DASHBOARD VIEW -->
      <section class="view is-active" data-view="dashboard">
        <h2 class="section-title">Задачи на завтра <span data-dashboard-date></span></h2>
        <div class="stats-row">
          <div class="stat-box">Нагрузка: <span data-dashboard-stat="planned">0:00</span></div>
          <div class="stat-box">Выполнено: <span data-dashboard-stat="done">0:00</span></div>
          <div class="stat-box">Осталось: <span data-dashboard-stat="left">0:00</span></div>
          <div class="stat-box">Финиш: <span data-dashboard-stat="eta">0:00</span></div>
        </div>

        <div class="section">
          <div class="section-head">

          </div>
          <div class="task-list" data-dashboard-tasks></div>
            <button class="btn btn-danger" data-action="reset-day">Очистить день</button>
            <button class="btn" data-action="reset-to-schedule">Вернуть к расписанию</button>
            <button class="btn primary full" data-action="add-task" title="Добавить задачу">+</button>
        </div>

        <div class="section" data-dashboard-offload-wrapper hidden>
          <div class="section-head">
            <div class="muted">Разгрузка</div>
          </div>
          <div class="task-list" data-dashboard-offload></div>
        </div>
      </section>

      <!-- SCHEDULE VIEW -->
      <section class="view" data-view="schedule">
        <h2 class="section-title">Недельное расписание</h2>
        <div class="week-grid" data-schedule-week></div>
      </section>

      <!-- CALENDAR VIEW -->
      <section class="view" data-view="calendar">
        <h2 class="section-title">Календарь</h2>
        <div class="calendar-header">
          <button class="btn" data-calendar-prev>←</button>
          <span class="cal-label" data-calendar-label></span>
          <button class="btn" data-calendar-next>→</button>
        </div>
        <div class="calendar-grid" data-calendar-grid></div>
        <div class="muted small">На дашборде всегда показывается D+1.</div>
      </section>
    </main>

    <footer class="footer">
      <small>v0.2 • MVP • localStorage</small>
    </footer>

    <script type="module" src="src/app.js"></script>
  </body>
</html>


